!function(t){function e(s){if(i[s])return i[s].exports;var r=i[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,e),r.l=!0,r.exports}var i={};e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:s})},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=4)}([function(t,e,i){"use strict";function s(t){this.data=new t(1),this.data[0]=0}function r(){s.call(this,s.TYPE_8BIT)}function n(){s.call(this,s.TYPE_16BIT),this.bytes=new Uint8Array(this.data.buffer)}i.d(e,"b",function(){return r}),i.d(e,"a",function(){return n});var o=i(1);s.TYPE_8BIT=Uint8Array,s.TYPE_16BIT=Uint16Array,Object.assign(s.prototype,{isRegister:!0,getWidth:function(){return 8*this.data.byteLength},load:function(){return this.data[0]},loadBit:function(t){return this.data[0]>>t&1},loadBits:function(t,e){return this.data[0]>>t&(1<<e)-1},store:function(t){this.data[0]=t},storeBit:function(t,e){e&=1,this.data[0]=this.data[0]&~(1<<t)|e<<t},storeBits:function(t,e,i){var s=(1<<e)-1;i&=s,this.data[0]=this.data[0]&~(s<<t)|i<<t},clear:function(){this.data[0]=0},setBit:function(t){this.storeBit(t,1)},clearBit:function(t){this.storeBit(t,0)},isBitSet:function(t){return 1===this.loadBit(t)},increment:function(){this.data[0]++},incrementBy2:function(){this.data[0]+=2},add:function(t){this.data[0]+=t},decrement:function(){this.data[0]--},decrementBy2:function(){this.data[0]-=2},sub:function(t){this.data[0]-=t},shift:function(t){t&=1;var e=this.loadBit(this.getWidth()-1);return this.data[0]=this.data[0]<<1|t,e},dump:function(){return o.a.convertDecToHexString(this.load(),this.getWidth()/4)}}),r.prototype=Object.assign(Object.create(s.prototype),{isRegister8bit:!0}),n.prototype=Object.assign(Object.create(s.prototype),{isRegister16bit:!0,loadHigherByte:function(){return this.bytes[1]},loadLowerByte:function(){return this.bytes[0]},storeHigherByte:function(t){this.bytes[1]=t},storeLowerByte:function(t){this.bytes[0]=t}})},function(t,e,i){"use strict";function s(){}i.d(e,"a",function(){return s}),s.convertDecToHexString=function(t,e,i){var s=t.toString(16),r="";if(t<0&&(r+="-"),!0!==i&&(r+="0x"),void 0===e)return r+s;for(var n="",o=0;o<e;o++)n+="0";return r+(n+s).substr(-1*e)}},function(t,e,i){"use strict";function s(t){this.data=new Uint8Array(t)}i.d(e,"a",function(){return s});var r=i(1);Object.assign(s.prototype,{isMemory:!0,clear:function(){for(var t=0,e=this.getCapacity();t<e;t++)this.storeWithoutMapping(t,0)},getCapacity:function(){return this.data.byteLength},load:function(t){return this.data[t]},loadWithoutMapping:function(t){return this.data[t]},store:function(t,e){this.data[t]=e},storeWithoutMapping:function(t,e){this.data[t]=e},dump:function(){for(var t="",e=!1,i=this._getStartDumpAddress(),s=this._getEndDumpAddress(),n=i;n<s;n++){if(n%16==0){if(e){for(var o=!1;this._checkNext16BytesIsZero(n+16);)n+=16,o=!0;o&&(t+="...\n")}t+=r.a.convertDecToHexString(n-i,4)+" ",e=!0}var c=this._loadForDump(n);t+=r.a.convertDecToHexString(c,2,!0)+" ",0!=c&&(e=!1),n%16==15&&(t+="\n")}return t},_loadForDump:function(t){return this.loadWithoutMapping(t)},_getStartDumpAddress:function(){return 0},_getEndDumpAddress:function(){return this.getCapacity()},_checkNext16BytesIsZero:function(t){if(t+16>=this._getEndDumpAddress())return!1;for(var e=0,i=t;i<t+16;i++)e+=this._loadForDump(i);return 0===e}})},function(t,e,i){"use strict";function s(){this.register=new r.b,this.latch=0,this.currentButton=0,this.buttonNum=this.getButtonsNum(),this.buttons=[];for(var t=0;t<this.buttonNum;t++)this.buttons[t]=!1}i.d(e,"a",function(){return s});var r=i(0);s.BUTTONS={A:0,B:1,SELECT:2,START:3,UP:4,DOWN:5,LEFT:6,RIGHT:7},Object.assign(s.prototype,{isJoypad:!0,getButtonsNum:function(){var t=0;for(var e in s.BUTTONS)t++;return t},pressButton:function(t){this.buttons[t]=!0},releaseButton:function(t){this.buttons[t]=!1},loadRegister:function(){var t=1===this.latch?0:this.currentButton++;return t>=this.buttonNum||this.buttons[t]?1:0},storeRegister:function(t){this.register.store(t),t&=1,1===t&&(this.currentButton=0),this.latch=t},dump:function(){}})},function(t,e,i){"use strict";function s(){}Object.defineProperty(e,"__esModule",{value:!0});var r=i(5),n=i(9),o=i(11),c=i(12),a=i(3);s.Nes=r.a,s.Rom=n.a,s.Audio=o.a,s.Display=c.a,s.Joypad=a.a,void 0!==window&&(window.NesJs=s)},function(t,e,i){"use strict";function s(){this.ppu=new n.a,this.cpu=new r.a,this.apu=new o.a,this.pad1=new c.a,this.pad2=new c.a,this.rom=null,this.cpu.setPpu(this.ppu),this.cpu.setApu(this.apu),this.cpu.setJoypad1(this.pad1),this.cpu.setJoypad2(this.pad2),this.ppu.setCpu(this.cpu),this.apu.setCpu(this.cpu),this.state=this.STATES.POWER_OFF,this.audioEnabled=!1;var t=this;this.runFunc=function(){t.run()},this.onFpsUpdates=[]}i.d(e,"a",function(){return s});var r=i(6),n=i(7),o=i(8),c=i(3);Object.assign(s.prototype,{isNes:!0,STATES:{POWER_OFF:0,RUN:1,STOP:2},KEY_TO_PAD_BUTTONS:{13:c.a.BUTTONS.START,32:c.a.BUTTONS.SELECT,37:c.a.BUTTONS.LEFT,38:c.a.BUTTONS.UP,39:c.a.BUTTONS.RIGHT,40:c.a.BUTTONS.DOWN,88:c.a.BUTTONS.A,90:c.a.BUTTONS.B},addEventListener:function(t,e){switch(t){case"fps":this.onFpsUpdates.push(e);break;default:throw new Error("Nes.addEventListener: unknown type "+t)}},invokeFpsUpdateListeners:function(t){for(var e=0,i=this.onFpsUpdates.length;e<i;e++)this.onFpsUpdates[e](t)},setRom:function(t){this.rom=t,this.cpu.setRom(t),this.ppu.setRom(t)},setDisplay:function(t){this.ppu.setDisplay(t)},setAudio:function(t){this.apu.setAudio(t),this.audioEnabled=!0},bootup:function(){this.cpu.bootup(),this.ppu.bootup(),this.apu.bootup(),this.state=this.STATES.RUN},reset:function(){this.cpu.reset(),this.ppu.reset(),this.apu.reset()},stop:function(){this.state=this.STATES.STOP},resume:function(){this.state=this.STATES.RUN,this.run()},run:function(){this.measureFps();for(var t=0;t<29780;t++)this.runCycle();this.state===this.STATES.RUN&&requestAnimationFrame(this.runFunc)},runCycle:function(){this.cpu.runCycle(),this.ppu.runCycle(),this.ppu.runCycle(),this.ppu.runCycle(),!0===this.audioEnabled&&this.apu.runCycle()},runStep:function(){if(this.state===this.STATES.STOP)do{this.runCycle()}while(this.cpu.isStall())},handleKeyDown:function(t){void 0!==this.KEY_TO_PAD_BUTTONS[t.keyCode]&&this.pad1.pressButton(this.KEY_TO_PAD_BUTTONS[t.keyCode]),t.preventDefault()},handleKeyUp:function(t){void 0!==this.KEY_TO_PAD_BUTTONS[t.keyCode]&&this.pad1.releaseButton(this.KEY_TO_PAD_BUTTONS[t.keyCode]),t.preventDefault()},measureFps:function(){var t=null,e=0;return function(){if(60===e){var i=performance.now();null!==t&&this.invokeFpsUpdateListeners(6e4/(i-t)),t=i,e=0}e++}}(),dumpCpu:function(){return this.cpu.dump()},dumpRam:function(){return this.cpu.dumpRAM()},dumpRom:function(){var t="";return t+=this.rom.dumpHeader(),t+="\n",t+=this.rom.dump(),t+="\n",t+=this.cpu.disassembleROM(),t+="\n"},dumpPpu:function(){return this.ppu.dump()},dumpVRam:function(){return this.ppu.dumpVRAM()},dumpSprRam:function(){return this.ppu.dumpSPRRAM()}})},function(t,e,i){"use strict";function s(){this.pc=new n.a,this.sp=new n.b,this.a=new n.b,this.x=new n.b,this.y=new n.b,this.p=new r,this.ram=new o.a(65536),this.ppu=null,this.apu=null,this.pad1=null,this.pad2=null,this.rom=null,this.stallCycle=0}function r(){n.b.call(this)}i.d(e,"a",function(){return s});var n=i(0),o=i(2),c=i(1);s.INTERRUPTS={NMI:0,RESET:1,IRQ:2,BRK:3},s.INTERRUPT_HANDLER_ADDRESSES=[],s.INTERRUPT_HANDLER_ADDRESSES[s.INTERRUPTS.NMI]=65530,s.INTERRUPT_HANDLER_ADDRESSES[s.INTERRUPTS.RESET]=65532,s.INTERRUPT_HANDLER_ADDRESSES[s.INTERRUPTS.IRQ]=65534,s.INTERRUPT_HANDLER_ADDRESSES[s.INTERRUPTS.BRK]=65534,s.INSTRUCTIONS={INV:{id:0,name:"inv"},ADC:{id:1,name:"adc"},AND:{id:2,name:"and"},ASL:{id:3,name:"asl"},BCC:{id:4,name:"bcc"},BCS:{id:5,name:"bcs"},BEQ:{id:6,name:"beq"},BIT:{id:7,name:"bit"},BMI:{id:8,name:"bmi"},BNE:{id:9,name:"bne"},BPL:{id:10,name:"bpl"},BRK:{id:11,name:"brk"},BVC:{id:12,name:"bvc"},BVS:{id:13,name:"bvs"},CLC:{id:14,name:"clc"},CLD:{id:15,name:"cld"},CLI:{id:16,name:"cli"},CLV:{id:17,name:"clv"},CMP:{id:18,name:"cmp"},CPX:{id:19,name:"cpx"},CPY:{id:20,name:"cpy"},DEC:{id:21,name:"dec"},DEX:{id:22,name:"dex"},DEY:{id:23,name:"dey"},EOR:{id:24,name:"eor"},INC:{id:25,name:"inc"},INX:{id:26,name:"inx"},INY:{id:27,name:"iny"},JMP:{id:28,name:"jmp"},JSR:{id:29,name:"jsr"},LDA:{id:30,name:"lda"},LDX:{id:31,name:"ldx"},LDY:{id:32,name:"ldy"},LSR:{id:33,name:"lsr"},NOP:{id:34,name:"nop"},ORA:{id:35,name:"ora"},PHA:{id:36,name:"pha"},PHP:{id:37,name:"php"},PLA:{id:38,name:"pla"},PLP:{id:39,name:"plp"},ROL:{id:40,name:"rol"},ROR:{id:41,name:"ror"},RTI:{id:42,name:"rti"},RTS:{id:43,name:"rts"},SBC:{id:44,name:"sbc"},SEC:{id:45,name:"sec"},SED:{id:46,name:"sed"},SEI:{id:47,name:"sei"},STA:{id:48,name:"sta"},STX:{id:49,name:"stx"},STY:{id:50,name:"sty"},TAX:{id:51,name:"tax"},TAY:{id:52,name:"tay"},TSX:{id:53,name:"tsx"},TXA:{id:54,name:"txa"},TXS:{id:55,name:"txs"},TYA:{id:56,name:"tya"}},s.ADDRESSINGS={IMMEDIATE:{id:0,pc:2,name:"immediate"},ABSOLUTE:{id:1,pc:3,name:"absolute"},INDEXED_ABSOLUTE_X:{id:2,pc:3,name:"indexed_absolute_x"},INDEXED_ABSOLUTE_Y:{id:3,pc:3,name:"indexed_absolute_y"},ZERO_PAGE:{id:4,pc:2,name:"zero_page"},INDEXED_ZERO_PAGE_X:{id:5,pc:2,name:"indexed_zero_page_x"},INDEXED_ZERO_PAGE_Y:{id:6,pc:2,name:"indexed_zero_page_y"},IMPLIED:{id:7,pc:1,name:"implied"},ACCUMULATOR:{id:8,pc:1,name:"accumulator"},INDIRECT:{id:9,pc:3,name:"indirect"},INDEXED_INDIRECT_X:{id:10,pc:2,name:"indexed_indirect_x"},INDEXED_INDIRECT_Y:{id:11,pc:2,name:"indexed_indirect_y"},RELATIVE:{id:12,pc:2,name:"relative"}},s.OPS=[{instruction:s.INSTRUCTIONS.BRK,cycle:7,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.ORA,cycle:6,mode:s.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.ORA,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.ASL,cycle:5,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.PHP,cycle:3,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.ORA,cycle:2,mode:s.ADDRESSINGS.IMMEDIATE},{instruction:s.INSTRUCTIONS.ASL,cycle:2,mode:s.ADDRESSINGS.ACCUMULATOR},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.ORA,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.ASL,cycle:6,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.BPL,cycle:2,mode:s.ADDRESSINGS.RELATIVE},{instruction:s.INSTRUCTIONS.ORA,cycle:5,mode:s.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.ORA,cycle:4,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.ASL,cycle:6,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.CLC,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.ORA,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.ORA,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.ASL,cycle:7,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.JSR,cycle:0,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.AND,cycle:6,mode:s.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.BIT,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.AND,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.ROL,cycle:5,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.PLP,cycle:4,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.AND,cycle:2,mode:s.ADDRESSINGS.IMMEDIATE},{instruction:s.INSTRUCTIONS.ROL,cycle:2,mode:s.ADDRESSINGS.ACCUMULATOR},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.BIT,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.AND,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.ROL,cycle:6,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.BMI,cycle:2,mode:s.ADDRESSINGS.RELATIVE},{instruction:s.INSTRUCTIONS.AND,cycle:5,mode:s.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.AND,cycle:4,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.ROL,cycle:6,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.SEC,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.AND,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.AND,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.ROL,cycle:7,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.RTI,cycle:6,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.EOR,cycle:6,mode:s.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.EOR,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.LSR,cycle:5,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.PHA,cycle:3,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.EOR,cycle:2,mode:s.ADDRESSINGS.IMMEDIATE},{instruction:s.INSTRUCTIONS.LSR,cycle:2,mode:s.ADDRESSINGS.ACCUMULATOR},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.JMP,cycle:0,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.EOR,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.LSR,cycle:6,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.BVC,cycle:2,mode:s.ADDRESSINGS.RELATIVE},{instruction:s.INSTRUCTIONS.EOR,cycle:5,mode:s.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.EOR,cycle:4,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.LSR,cycle:6,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.CLI,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.EOR,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.EOR,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.LSR,cycle:7,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.RTS,cycle:6,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.ADC,cycle:6,mode:s.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.ADC,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.ROR,cycle:5,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.PLA,cycle:4,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.ADC,cycle:2,mode:s.ADDRESSINGS.IMMEDIATE},{instruction:s.INSTRUCTIONS.ROR,cycle:2,mode:s.ADDRESSINGS.ACCUMULATOR},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.JMP,cycle:0,mode:s.ADDRESSINGS.INDIRECT},{instruction:s.INSTRUCTIONS.ADC,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.ROR,cycle:6,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.BVS,cycle:2,mode:s.ADDRESSINGS.RELATIVE},{instruction:s.INSTRUCTIONS.ADC,cycle:5,mode:s.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.ADC,cycle:4,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.ROR,cycle:6,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.SEI,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.ADC,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.ADC,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.ROR,cycle:7,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.STA,cycle:6,mode:s.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.STY,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.STA,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.STX,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.DEY,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.TXA,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.STY,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.STA,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.STX,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.BCC,cycle:2,mode:s.ADDRESSINGS.RELATIVE},{instruction:s.INSTRUCTIONS.STA,cycle:6,mode:s.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.STY,cycle:4,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.STA,cycle:4,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.STX,cycle:4,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.TYA,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.STA,cycle:5,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:s.INSTRUCTIONS.TXS,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.STA,cycle:5,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.LDY,cycle:2,mode:s.ADDRESSINGS.IMMEDIATE},{instruction:s.INSTRUCTIONS.LDA,cycle:6,mode:s.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:s.INSTRUCTIONS.LDX,cycle:2,mode:s.ADDRESSINGS.IMMEDIATE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.LDY,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.LDA,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.LDX,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.TAY,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.LDA,cycle:2,mode:s.ADDRESSINGS.IMMEDIATE},{instruction:s.INSTRUCTIONS.TAX,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.LDY,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.LDA,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.LDX,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.BCS,cycle:2,mode:s.ADDRESSINGS.RELATIVE},{instruction:s.INSTRUCTIONS.LDA,cycle:5,mode:s.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.LDY,cycle:4,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.LDA,cycle:4,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.LDX,cycle:4,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.CLV,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.LDA,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:s.INSTRUCTIONS.TSX,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.LDY,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.LDA,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.LDX,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.CPY,cycle:2,mode:s.ADDRESSINGS.IMMEDIATE},{instruction:s.INSTRUCTIONS.CMP,cycle:6,mode:s.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.CPY,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.CMP,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.DEC,cycle:5,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INY,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.CMP,cycle:2,mode:s.ADDRESSINGS.IMMEDIATE},{instruction:s.INSTRUCTIONS.DEX,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.CPY,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.CMP,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.DEC,cycle:6,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.BNE,cycle:2,mode:s.ADDRESSINGS.RELATIVE},{instruction:s.INSTRUCTIONS.CMP,cycle:5,mode:s.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.CMP,cycle:4,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.DEC,cycle:6,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.CLD,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.CMP,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.CMP,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.DEC,cycle:7,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.CPX,cycle:2,mode:s.ADDRESSINGS.IMMEDIATE},{instruction:s.INSTRUCTIONS.SBC,cycle:6,mode:s.ADDRESSINGS.INDEXED_INDIRECT_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.CPX,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.SBC,cycle:3,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.INC,cycle:5,mode:s.ADDRESSINGS.ZERO_PAGE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INX,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.SBC,cycle:2,mode:s.ADDRESSINGS.IMMEDIATE},{instruction:s.INSTRUCTIONS.NOP,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.CPX,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.SBC,cycle:4,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.INC,cycle:6,mode:s.ADDRESSINGS.ABSOLUTE},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.BEQ,cycle:2,mode:s.ADDRESSINGS.RELATIVE},{instruction:s.INSTRUCTIONS.SBC,cycle:5,mode:s.ADDRESSINGS.INDEXED_INDIRECT_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.SBC,cycle:4,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.INC,cycle:6,mode:s.ADDRESSINGS.INDEXED_ZERO_PAGE_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.SED,cycle:2,mode:s.ADDRESSINGS.IMPLIED},{instruction:s.INSTRUCTIONS.SBC,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_Y},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null},{instruction:s.INSTRUCTIONS.SBC,cycle:4,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.INC,cycle:7,mode:s.ADDRESSINGS.INDEXED_ABSOLUTE_X},{instruction:s.INSTRUCTIONS.INV,cycle:0,mode:null}],Object.assign(s.prototype,{isCpu:!0,INTERRUPTS:s.INTERRUPTS,INTERRUPT_HANDLER_ADDRESSES:s.INTERRUPT_HANDLER_ADDRESSES,ADDRESSINGS:s.ADDRESSINGS,INSTRUCTIONS:s.INSTRUCTIONS,OPS:s.OPS,setPpu:function(t){this.ppu=t},setApu:function(t){this.apu=t},setJoypad1:function(t){this.pad1=t},setJoypad2:function(t){this.pad2=t},setRom:function(t){this.rom=t},bootup:function(){this.p.store(52),this.a.clear(),this.x.clear(),this.y.clear(),this.sp.store(253);for(var t=0;t<15;t++)this.store(16384+t,0);this.store(16405,0),this.store(16407,0),this.interrupt(this.INTERRUPTS.RESET)},reset:function(){this.sp.sub(3),this.p.setI(),this.interrupt(this.INTERRUPTS.RESET)},runCycle:function(){if(!0!==this.isStall()){var t=this.fetch(),e=this.decode(t);this.operate(e,t),this.stallCycle=e.cycle}this.stallCycle--},isStall:function(){return this.stallCycle>0},interrupt:function(t){t===this.INTERRUPTS.IRQ&&!0===this.p.isI()||(t!==this.INTERRUPTS.RESET&&(t!==this.INTERRUPTS.BRK&&this.p.clearB(),this.p.setA(),this.pushStack2Bytes(this.pc.load()),this.pushStack(this.p.load()),this.p.setI()),this.jumpToInterruptHandler(t))},load:function(t){return t&=65535,t>=0&&t<8192?this.ram.load(2047&t):t>=8192&&t<16384?this.ppu.loadRegister(8199&t):t>=16384&&t<16404?this.apu.loadRegister(t):16404===t?this.ppu.loadRegister(t):16405===t?this.apu.loadRegister(t):16406===t?this.pad1.loadRegister():t>=16407&&t<16416?this.apu.loadRegister(t):t>=16416&&t<24576?this.ram.load(t):t>=24576&&t<32768?this.ram.load(t):t>=32768&&t<65536?this.rom.load(t):void 0},store:function(t,e){return t&=65535,t>=0&&t<8192?this.ram.store(2047&t,e):t>=8192&&t<16384?this.ppu.storeRegister(8199&t,e):t>=16384&&t<16404?this.apu.storeRegister(t,e):16404===t?this.ppu.storeRegister(t,e):16405===t?this.apu.storeRegister(t,e):16406===t?this.pad1.storeRegister(e):t>=16407&&t<16416?this.apu.storeRegister(t,e):t>=16416&&t<24576?this.ram.store(t,e):t>=24576&&t<32768?this.ram.store(t,e):t>=32768&&t<65536?this.rom.store(t,e):void 0},load2Bytes:function(t){return this.load(t)|this.load(t+1)<<8},load2BytesFromZeropage:function(t){return this.ram.load(255&t)|this.ram.load(t+1&255)<<8},load2BytesInPage:function(t){var e=t,i=65280&t|t+1&255;return this.load(e)|this.load(i)<<8},store2Bytes:function(t,e){this.store(t,e),this.store(t+1,e>>8)},fetch:function(){var t=this.load(this.pc.load());return this.pc.increment(),t},decode:function(t){return this.OPS[t]},jumpToInterruptHandler:function(t){this.pc.store(this.load2Bytes(this.INTERRUPT_HANDLER_ADDRESSES[t]))},loadWithAddressingMode:function(t){if(t.mode.id===this.ADDRESSINGS.ACCUMULATOR.id)return this.a.load();var e=this.getAddressWithAddressingMode(t),i=this.load(e);return t.mode.id===this.ADDRESSINGS.RELATIVE.id&&128&i&&(i|=65280),i},storeWithAddressingMode:function(t,e){if(t.mode.id===this.ADDRESSINGS.ACCUMULATOR.id)return void this.a.store(e);var i=this.getAddressWithAddressingMode(t);this.store(i,e)},updateMemoryWithAddressingMode:function(t,e){var i,s;t.mode.id==this.ADDRESSINGS.ACCUMULATOR.id?s=this.a.load():(i=this.getAddressWithAddressingMode(t),s=this.load(i));var r=e(s);t.mode.id==this.ADDRESSINGS.ACCUMULATOR.id?this.a.store(r):this.store(i,r)},getAddressWithAddressingMode:function(t){var e=null;switch(t.mode.id){case this.ADDRESSINGS.IMMEDIATE.id:case this.ADDRESSINGS.RELATIVE.id:e=this.pc.load(),this.pc.increment();break;case this.ADDRESSINGS.ABSOLUTE.id:case this.ADDRESSINGS.INDEXED_ABSOLUTE_X.id:case this.ADDRESSINGS.INDEXED_ABSOLUTE_Y.id:switch(e=this.load2Bytes(this.pc.load()),this.pc.incrementBy2(),t.mode.id){case this.ADDRESSINGS.INDEXED_ABSOLUTE_X.id:e+=this.x.load();break;case this.ADDRESSINGS.INDEXED_ABSOLUTE_Y.id:e+=this.y.load()}e&=65535;break;case this.ADDRESSINGS.ZERO_PAGE.id:case this.ADDRESSINGS.INDEXED_ZERO_PAGE_X.id:case this.ADDRESSINGS.INDEXED_ZERO_PAGE_Y.id:switch(e=this.load(this.pc.load()),this.pc.increment(),t.mode.id){case this.ADDRESSINGS.INDEXED_ZERO_PAGE_X.id:e+=this.x.load();break;case this.ADDRESSINGS.INDEXED_ZERO_PAGE_Y.id:e+=this.y.load()}e&=255;break;case this.ADDRESSINGS.INDIRECT.id:var i=this.load2Bytes(this.pc.load());this.pc.incrementBy2(),e=this.load2BytesInPage(i);break;case this.ADDRESSINGS.INDEXED_INDIRECT_X.id:var i=this.load(this.pc.load());this.pc.increment(),i+=this.x.load(),i&=255,e=this.load2BytesFromZeropage(i);break;case this.ADDRESSINGS.INDEXED_INDIRECT_Y.id:var i=this.load(this.pc.load());this.pc.increment(),e=this.load2BytesFromZeropage(i),e+=this.y.load(),e&=65535;break;default:throw new Error("Cpu: Unkown addressing mode.")}return e},updateN:function(t){0==(128&t)?this.p.clearN():this.p.setN()},updateZ:function(t){0==(255&t)?this.p.setZ():this.p.clearZ()},updateC:function(t){0==(256&t)?this.p.clearC():this.p.setC()},getStackAddress:function(){return this.sp.load()+256},pushStack:function(t){this.store(this.getStackAddress(),t),this.sp.decrement()},pushStack2Bytes:function(t){this.store(this.getStackAddress(),t>>8&255),this.sp.decrement(),this.store(this.getStackAddress(),255&t),this.sp.decrement()},popStack:function(){return this.sp.increment(),this.load(this.getStackAddress())},popStack2Bytes:function(){this.sp.increment();var t=this.load(this.getStackAddress());return this.sp.increment(),this.load(this.getStackAddress())<<8|t},doBranch:function(t,e){var i=this.loadWithAddressingMode(t);e&&this.pc.add(i)},operate:function(t,e){switch(t.instruction.id){case this.INSTRUCTIONS.ADC.id:var i=this.a.load(),s=this.loadWithAddressingMode(t),r=this.p.isC()?1:0,n=i+s+r;this.a.store(n),this.updateN(n),this.updateZ(n),this.updateC(n),!(128&(i^s))&&128&(s^n)?this.p.setV():this.p.clearV();break;case this.INSTRUCTIONS.AND.id:var i=this.a.load(),s=this.loadWithAddressingMode(t),n=i&s;this.a.store(n),this.updateN(n),this.updateZ(n);break;case this.INSTRUCTIONS.ASL.id:var o=this,a=function(t){var e=t<<1;return o.updateN(e),o.updateZ(e),o.updateC(e),e};this.updateMemoryWithAddressingMode(t,a);break;case this.INSTRUCTIONS.BCC.id:this.doBranch(t,!this.p.isC());break;case this.INSTRUCTIONS.BCS.id:this.doBranch(t,this.p.isC());break;case this.INSTRUCTIONS.BEQ.id:this.doBranch(t,this.p.isZ());break;case this.INSTRUCTIONS.BIT.id:var i=this.a.load(),s=this.loadWithAddressingMode(t),n=i&s;this.updateN(s),this.updateZ(n),0==(64&s)?this.p.clearV():this.p.setV();break;case this.INSTRUCTIONS.BMI.id:this.doBranch(t,this.p.isN());break;case this.INSTRUCTIONS.BNE.id:this.doBranch(t,!this.p.isZ());break;case this.INSTRUCTIONS.BPL.id:this.doBranch(t,!this.p.isN());break;case this.INSTRUCTIONS.BRK.id:this.pc.increment(),this.p.setA(),this.p.setB(),this.interrupt(this.INTERRUPTS.BRK);break;case this.INSTRUCTIONS.BVC.id:this.doBranch(t,!this.p.isV());break;case this.INSTRUCTIONS.BVS.id:this.doBranch(t,this.p.isV());break;case this.INSTRUCTIONS.CLC.id:this.p.clearC();break;case this.INSTRUCTIONS.CLD.id:this.p.clearD();break;case this.INSTRUCTIONS.CLI.id:this.p.clearI();break;case this.INSTRUCTIONS.CLV.id:this.p.clearV();break;case this.INSTRUCTIONS.CMP.id:case this.INSTRUCTIONS.CPX.id:case this.INSTRUCTIONS.CPY.id:var i;switch(t.instruction.id){case this.INSTRUCTIONS.CMP.id:i=this.a.load();break;case this.INSTRUCTIONS.CPX.id:i=this.x.load();break;case this.INSTRUCTIONS.CPY.id:i=this.y.load()}var s=this.loadWithAddressingMode(t),n=i-s;this.updateN(n),this.updateZ(n),i>=s?this.p.setC():this.p.clearC();break;case this.INSTRUCTIONS.DEC.id:var o=this,a=function(t){var e=t-1;return o.updateN(e),o.updateZ(e),e};this.updateMemoryWithAddressingMode(t,a);break;case this.INSTRUCTIONS.DEX.id:case this.INSTRUCTIONS.DEY.id:var h;switch(t.instruction.id){case this.INSTRUCTIONS.DEX.id:h=this.x;break;case this.INSTRUCTIONS.DEY.id:h=this.y}var i=h.load(),n=i-1;h.store(n),this.updateN(n),this.updateZ(n);break;case this.INSTRUCTIONS.EOR.id:var i=this.a.load(),s=this.loadWithAddressingMode(t),n=i^s;this.a.store(n),this.updateN(n),this.updateZ(n);break;case this.INSTRUCTIONS.INC.id:var o=this,a=function(t){var e=t+1;return o.updateN(e),o.updateZ(e),e};this.updateMemoryWithAddressingMode(t,a);break;case this.INSTRUCTIONS.INX.id:case this.INSTRUCTIONS.INY.id:var h;switch(t.instruction.id){case this.INSTRUCTIONS.INX.id:h=this.x;break;case this.INSTRUCTIONS.INY.id:h=this.y}var i=h.load(),n=i+1;h.store(n),this.updateN(n),this.updateZ(n);break;case this.INSTRUCTIONS.JMP.id:var S=this.getAddressWithAddressingMode(t);this.pc.store(S);break;case this.INSTRUCTIONS.JSR.id:var S=this.getAddressWithAddressingMode(t);this.pc.decrement(),this.pushStack2Bytes(this.pc.load()),this.pc.store(S);break;case this.INSTRUCTIONS.LDA.id:case this.INSTRUCTIONS.LDX.id:case this.INSTRUCTIONS.LDY.id:var h,n=this.loadWithAddressingMode(t);switch(t.instruction.id){case this.INSTRUCTIONS.LDA.id:h=this.a;break;case this.INSTRUCTIONS.LDX.id:h=this.x;break;case this.INSTRUCTIONS.LDY.id:h=this.y}h.store(n),this.updateN(n),this.updateZ(n);break;case this.INSTRUCTIONS.LSR.id:var o=this,a=function(t){var e=t>>1;return o.p.clearN(),o.updateZ(e),0==(1&t)?o.p.clearC():o.p.setC(),e};this.updateMemoryWithAddressingMode(t,a);break;case this.INSTRUCTIONS.NOP.id:break;case this.INSTRUCTIONS.ORA.id:var i=this.a.load(),s=this.loadWithAddressingMode(t),n=i|s;this.a.store(n),this.updateN(n),this.updateZ(n);break;case this.INSTRUCTIONS.PHA.id:case this.INSTRUCTIONS.PHP.id:var h;switch(t.instruction.id){case this.INSTRUCTIONS.PHA.id:h=this.a;break;case this.INSTRUCTIONS.PHP.id:this.p.setA(),this.p.setB(),h=this.p}this.pushStack(h.load());break;case this.INSTRUCTIONS.PLA.id:var n=this.popStack();this.a.store(n),this.updateN(n),this.updateZ(n);break;case this.INSTRUCTIONS.PLP.id:this.p.store(this.popStack());break;case this.INSTRUCTIONS.ROL.id:var o=this,a=function(t){var e=o.p.isC()?1:0,i=t<<1|e;return o.updateN(i),o.updateZ(i),o.updateC(i),i};this.updateMemoryWithAddressingMode(t,a);break;case this.INSTRUCTIONS.ROR.id:var o=this,a=function(t){var e=o.p.isC()?128:0,i=t>>1|e;return o.updateN(i),o.updateZ(i),0==(1&t)?o.p.clearC():o.p.setC(),i};this.updateMemoryWithAddressingMode(t,a);break;case this.INSTRUCTIONS.RTI.id:this.p.store(this.popStack()),this.pc.store(this.popStack2Bytes());break;case this.INSTRUCTIONS.RTS.id:this.pc.store(this.popStack2Bytes()+1);break;case this.INSTRUCTIONS.SBC.id:var i=this.a.load(),s=this.loadWithAddressingMode(t),r=this.p.isC()?0:1,n=i-s-r;this.a.store(n),this.updateN(n),this.updateZ(n),i>=s+r?this.p.setC():this.p.clearC(),128&(i^n)&&128&(i^s)?this.p.setV():this.p.clearV();break;case this.INSTRUCTIONS.SEC.id:this.p.setC();break;case this.INSTRUCTIONS.SED.id:this.p.setD();break;case this.INSTRUCTIONS.SEI.id:this.p.setI();break;case this.INSTRUCTIONS.STA.id:case this.INSTRUCTIONS.STX.id:case this.INSTRUCTIONS.STY.id:var h;switch(t.instruction.id){case this.INSTRUCTIONS.STA.id:h=this.a;break;case this.INSTRUCTIONS.STX.id:h=this.x;break;case this.INSTRUCTIONS.STY.id:h=this.y}this.storeWithAddressingMode(t,h.load());break;case this.INSTRUCTIONS.TAX.id:case this.INSTRUCTIONS.TAY.id:case this.INSTRUCTIONS.TSX.id:case this.INSTRUCTIONS.TXA.id:case this.INSTRUCTIONS.TXS.id:case this.INSTRUCTIONS.TYA.id:var u,I;switch(t.instruction.id){case this.INSTRUCTIONS.TAX.id:u=this.a,I=this.x;break;case this.INSTRUCTIONS.TAY.id:u=this.a,I=this.y;break;case this.INSTRUCTIONS.TSX.id:u=this.sp,I=this.x;break;case this.INSTRUCTIONS.TXA.id:u=this.x,I=this.a;break;case this.INSTRUCTIONS.TXS.id:u=this.x,I=this.sp;break;case this.INSTRUCTIONS.TYA.id:u=this.y,I=this.a}var n=u.load();I.store(n),t.instruction.id!=this.INSTRUCTIONS.TXS.id&&(this.updateN(n),this.updateZ(n));break;default:throw new Error("Cpu.operate: Invalid instruction, pc="+c.a.convertDecToHexString(this.pc.load()-1)+" opc="+c.a.convertDecToHexString(e,2)+" name="+t.instruction.name)}},disassembleROM:function(){for(var t="",e=this.rom,i=e.getHeaderSize(),s=!1,r=!1;i<16400;){var n="",o=e.loadWithoutMapping(i),a=this.decode(o);if(s&&0==o&&0==e.loadWithoutMapping(i+1&65535))i+=1,r=!0;else{for(r&&(t+="...\n"),r=!1,n+=c.a.convertDecToHexString(i-e.getHeaderSize(),4)+" ",n+=c.a.convertDecToHexString(o,2)+" ",n+=a.instruction.name+" ",n+=this.dumpMemoryAddressingMode(a,e,i+1&65535)+" ";n.length<30;)n+=" ";a.mode?(n+=a.mode.name,i+=a.mode.pc):i+=1,t+=n+"\n",s=0==o}}return t},dump:function(){var t="",e=this.load(this.pc.load()),i=this.decode(e);for(t+="p:"+this.p.dump()+" ",t+="pc:"+this.pc.dump()+"("+c.a.convertDecToHexString(e,2)+") ",t+="sp:"+this.sp.dump()+" ",t+="a:"+this.a.dump()+" ",t+="x:"+this.x.dump()+" ",t+="y:"+this.y.dump()+" ",t+=i.instruction.name+" "+this.dumpMemoryAddressingMode(i,this,this.pc.load()+1&65535)+" ";t.length<90;)t+=" ";return t+=i.mode.name},dumpRAM:function(){return this.ram.dump()},dumpMemoryAddressingMode:function(t,e,i){var r="",n=e instanceof s;switch(t.mode){case this.ADDRESSINGS.IMMEDIATE:r+="#"+c.a.convertDecToHexString(e.load(i,!0),2);break;case this.ADDRESSINGS.RELATIVE:var o=e.load(i,!0);128&o&&(o=-(256-o)),r+=o.toString(10);break;case this.ADDRESSINGS.ABSOLUTE:var a=e.load2Bytes(i,!0);r+=c.a.convertDecToHexString(a,4),n&&(r+="("+c.a.convertDecToHexString(e.load(a,!0),2)+")");break;case this.ADDRESSINGS.INDEXED_ABSOLUTE_X:var a=e.load2Bytes(i,!0);r+=c.a.convertDecToHexString(a,4)+",X ",n&&(a+=this.x.load(),a&=65535,r+="("+c.a.convertDecToHexString(e.load(a,!0),2)+")");break;case this.ADDRESSINGS.INDEXED_ABSOLUTE_Y:var a=e.load2Bytes(i,!0);r+=c.a.convertDecToHexString(a,4)+",Y ",n&&(a+=this.y.load(),a&=65535,r+="("+c.a.convertDecToHexString(e.load(a,!0),2)+")");break;case this.ADDRESSINGS.ZERO_PAGE:var a=e.load(i,!0);r+=c.a.convertDecToHexString(a,2),n&&(r+="("+c.a.convertDecToHexString(e.load(a,!0),2)+")");break;case this.ADDRESSINGS.INDEXED_ZERO_PAGE_X:var a=e.load(i,!0);r+=c.a.convertDecToHexString(a,2)+",X ",n&&(a+=this.x.load(),a&=255,r+="("+c.a.convertDecToHexString(e.load(a,!0),2)+")");break;case this.ADDRESSINGS.INDEXED_ZERO_PAGE_Y:var a=e.load(i,!0);r+=c.a.convertDecToHexString(a,2)+",Y ",n&&(a+=this.y.load(),a&=255,r+="("+c.a.convertDecToHexString(e.load(a,!0),2)+")");break;case this.ADDRESSINGS.INDIRECT:var a=e.load2Bytes(i,!0);if(r+=c.a.convertDecToHexString(a,4),n){var h=e.load2Bytes(a,!0);r+="(",r+=c.a.convertDecToHexString(h,4),r+="("+c.a.convertDecToHexString(e.load(h,!0),2)+")",r+=")"}break;case this.ADDRESSINGS.INDEXED_INDIRECT_X:var a=e.load(i,!0);if(r+="("+c.a.convertDecToHexString(a,2)+",X) ",n){a+=this.x.load(),a&=65535;var h=e.load2Bytes(a,!0);r+="(",r+=c.a.convertDecToHexString(h,4),r+="("+c.a.convertDecToHexString(e.load(h,!0),2)+")",r+=")"}break;case this.ADDRESSINGS.INDEXED_INDIRECT_Y:var a=e.load(i,!0);if(r+="("+c.a.convertDecToHexString(a,2)+"),Y ",n){var h=e.load2BytesFromZeropage(a,!0);h+=this.y.load(),h&=65535,r+="(",r+=c.a.convertDecToHexString(h,4),r+="("+c.a.convertDecToHexString(e.load(h,!0),2)+")",r+=")"}break;case this.ADDRESSINGS.ACCUMULATOR:n&&(r+="A("+c.a.convertDecToHexString(this.a.load(),2)+")");break;default:throw new Error("Cpu: Unkown addressing mode.")}return r}}),r.prototype=Object.assign(Object.create(n.b.prototype),{isCpuStatusRegister:!0,N_BIT:7,V_BIT:6,A_BIT:5,B_BIT:4,D_BIT:3,I_BIT:2,Z_BIT:1,C_BIT:0,isN:function(){return this.isBitSet(this.N_BIT)},setN:function(){this.setBit(this.N_BIT)},clearN:function(){this.clearBit(this.N_BIT)},isV:function(){return this.isBitSet(this.V_BIT)},setV:function(){this.setBit(this.V_BIT)},clearV:function(){this.clearBit(this.V_BIT)},isA:function(){return this.IsBitSet(this.A_BIT)},setA:function(){this.setBit(this.A_BIT)},clearA:function(){this.clearBit(this.A_BIT)},isB:function(){return this.isBitSet(this.B_BIT)},setB:function(){this.setBit(this.B_BIT)},clearB:function(){this.clearBit(this.B_BIT)},isD:function(){return this.isBitSet(this.D_BIT)},setD:function(){this.setBit(this.D_BIT)},clearD:function(){this.clearBit(this.D_BIT)},isI:function(){return this.isBitSet(this.I_BIT)},setI:function(){this.setBit(this.I_BIT)},clearI:function(){this.clearBit(this.I_BIT)},isZ:function(){return this.isBitSet(this.Z_BIT)},setZ:function(){this.setBit(this.Z_BIT)},clearZ:function(){this.clearBit(this.Z_BIT)},isC:function(){return this.isBitSet(this.C_BIT)},setC:function(){this.setBit(this.C_BIT)},clearC:function(){this.clearBit(this.C_BIT)},dump:function(){var t="";return t+=n.b.prototype.dump.call(this),t+="(",t+=this.isN()?"N":"-",t+=this.isV()?"V":"-",t+=this.isB()?"B":"-",t+=this.isD()?"D":"-",t+=this.isI()?"I":"-",t+=this.isZ()?"Z":"-",t+=this.isC()?"C":"-",t+=")"}})},function(t,e,i){"use strict";function s(){this.frame=0,this.scanLine=0,this.cycle=0,this.cpu=null,this.rom=null,this.display=null,this.vRam=new S.a(16384),this.oamRam=new S.a(256),this.oamRam2=new S.a(32),this.ppuctrl=new r,this.ppumask=new n,this.ppustatus=new o,this.oamaddr=new h.b,this.oamdata=new h.b,this.ppuscroll=new h.b,this.ppuaddr=new h.b,this.ppudata=new h.b,this.oamdma=new h.b,this.nameTableRegister=new h.b,this.attributeTableLowRegister=new h.a,this.attributeTableHighRegister=new h.a,this.patternTableLowRegister=new h.a,this.patternTableHighRegister=new h.a,this.nameTableLatch=0,this.attributeTableLowLatch=0,this.attributeTableHighLatch=0,this.patternTableLowLatch=0,this.patternTableHighLatch=0,this.fineXScroll=0,this.currentVRamAddress=0,this.temporalVRamAddress=0,this.vRamReadBuffer=0,this.registerFirstStore=!0,this.spritesManager=new c(this.oamRam),this.spritesManager2=new c(this.oamRam2),this.spritePixels=[],this.spriteIds=[],this.spritePriorities=[];for(var t=0;t<256;t++)this.spritePixels[t]=-1,this.spriteIds[t]=-1,this.spritePriorities[t]=-1}function r(){h.b.call(this)}function n(){h.b.call(this)}function o(){h.b.call(this)}function c(t){this.sprites=[],this.init(t)}function a(t,e,i){this.index=t,this.id=e,this.memory=i}i.d(e,"a",function(){return s});var h=i(0),S=i(2),u=i(1);Object.assign(s.prototype,{isPpu:!0,PALETTES:[4285887861,4287568679,4289396736,4288610375,4285989007,4279435435,4278190247,4278193023,4278202179,4278208256,4278210816,4279713536,4284432155,4278190080,4278190080,4278190080,4290559164,4293882624,4293868323,4294115459,4290707647,4284154087,4278201307,4279193547,4278219659,4278228736,4278233856,4282094336,4287333120,4278190080,4278190080,4278190080,4294967295,4294950719,4294940511,4294806439,4294933495,4290213887,4284708863,4282096639,4282367987,4279489411,4283162447,4288215128,4292602624,4278190080,4278190080,4278190080,4294967295,4294961067,4294956999,4294953943,4294952959,4292593663,4289970175,4289453055,4288931839,4288937955,4290769835,4291821491,4294180767,4278190080,4278190080,4278190080],setCpu:function(t){this.cpu=t},setRom:function(t){this.rom=t},setDisplay:function(t){this.display=t},bootup:function(){this.ppustatus.store(128)},reset:function(){},runCycle:function(){this.renderPixel(),this.shiftRegisters(),this.fetch(),this.evaluateSprites(),this.updateFlags(),this.countUpScrollCounters(),this.countUpCycle()},loadRegister:function(t){switch(t){case 8194:var e=this.ppustatus.load();return this.ppustatus.clearVBlank(),this.registerFirstStore=!0,e;case 8196:return this.oamRam.load(this.oamaddr.load());case 8199:var e;return(16383&this.currentVRamAddress)>=0&&(16383&this.currentVRamAddress)<16128?(e=this.vRamReadBuffer,this.vRamReadBuffer=this.load(this.currentVRamAddress)):(e=this.load(this.currentVRamAddress),this.vRamReadBuffer=e),this.incrementVRamAddress(),e}return 0},storeRegister:function(t,e){switch(t){case 8192:this.ppuctrl.store(e),this.temporalVRamAddress&=-3073,this.temporalVRamAddress|=(3&e)<<10;break;case 8193:this.ppumask.store(e);break;case 8195:this.oamaddr.store(e);break;case 8196:this.oamdata.store(e),this.oamRam.store(this.oamaddr.load(),e),this.oamaddr.increment();break;case 8197:this.ppuscroll.store(e),!0===this.registerFirstStore?(this.fineXScroll=7&e,this.temporalVRamAddress&=-32,this.temporalVRamAddress|=e>>3&31):(this.temporalVRamAddress&=-29665,this.temporalVRamAddress|=(248&e)<<2,this.temporalVRamAddress|=(7&e)<<12),this.registerFirstStore=!this.registerFirstStore;break;case 8198:!0===this.registerFirstStore?(this.temporalVRamAddress&=-32513,this.temporalVRamAddress|=(63&e)<<8):(this.ppuaddr.store(e),this.temporalVRamAddress&=-256,this.temporalVRamAddress|=255&e,this.currentVRamAddress=this.temporalVRamAddress),this.registerFirstStore=!this.registerFirstStore;break;case 8199:this.ppudata.store(e),this.store(this.currentVRamAddress,e),this.incrementVRamAddress();break;case 16404:this.oamdma.store(e);for(var i=256*e,s=this.oamaddr.load();s<256;s++)this.oamRam.store(s,this.cpu.load(i+s));this.cpu.stallCycle+=514}},load:function(t){return(t&=16383)<8192&&!0===this.rom.hasChrRom()?this.rom.load(t):t>=8192&&t<16128?this.vRam.load(this.getNameTableAddressWithMirroring(12287&t)):(t>=16128&&t<16384&&(t&=16159),16144===t&&(t=16128),16148===t&&(t=16132),16152===t&&(t=16136),16156===t&&(t=16140),this.vRam.load(t))},store:function(t,e){return(t&=16383)<8192&&!0===this.rom.hasChrRom()?void this.rom.store(t,e):t>=8192&&t<16128?void this.vRam.store(this.getNameTableAddressWithMirroring(12287&t),e):(t>=16128&&t<16384&&(t&=16159),16144===t&&(t=16128),16148===t&&(t=16132),16152===t&&(t=16136),16156===t&&(t=16140),this.vRam.store(t,e))},getNameTableAddressWithMirroring:function(t){t&=12287;var e=0;switch(this.rom.getMirroringType()){case this.rom.MIRRORINGS.SINGLE_SCREEN:e=8192;break;case this.rom.MIRRORINGS.HORIZONTAL:e=t>=8192&&t<9216?8192:t>=9216&&t<10240?8192:9216;break;case this.rom.MIRRORINGS.VERTICAL:e=t>=8192&&t<9216?8192:t>=9216&&t<10240?9216:t>=10240&&t<11264?8192:9216;break;case this.rom.MIRRORINGS.FOUR_SCREEN:e=t>=8192&&t<9216?8192:t>=9216&&t<10240?9216:t>=10240&&t<11264?10240:11264}return e|1023&t},renderPixel:function(){if(!(this.cycle>=257||this.scanLine>=240||0===this.cycle)){var t=this.cycle-1,e=this.scanLine,i=this.ppumask.isBackgroundVisible(),s=this.ppumask.isSpritesVisible(),r=this.getBackgroundPixel(),n=this.spritePixels[t],o=this.spriteIds[t],c=this.spritePriorities[t],a=this.PALETTES[this.load(16128)];!0===i&&!0===s?a=-1===n?r:r===a?n:0===c?n:r:!0===i&&!1===s?a=r:!1===i&&!0===s&&-1!==n&&(a=n),!0===this.ppumask.emphasisRed()&&(a|=16711680),!0===this.ppumask.emphasisGreen()&&(a|=65280),!0===this.ppumask.emphasisBlue()&&(a|=255),!0===i&&!0===s&&0===o&&0!==n&&0!==r&&this.ppustatus.setZeroHit(),this.display.renderPixel(t,e,a)}},getBackgroundPixel:function(){var t=15-this.fineXScroll,e=this.patternTableHighRegister.loadBit(t)<<1|this.patternTableLowRegister.loadBit(t),i=this.attributeTableHighRegister.loadBit(t)<<1|this.attributeTableLowRegister.loadBit(t),s=i<<2|e;return!0===this.ppumask.isGreyscale()&&(s&=48),this.PALETTES[this.load(16128+s)]},shiftRegisters:function(){this.scanLine>=240&&this.scanLine<=260||(this.cycle>=1&&this.cycle<=256||this.cycle>=329&&this.cycle<=336)&&(this.patternTableLowRegister.shift(0),this.patternTableHighRegister.shift(0),this.attributeTableLowRegister.shift(0),this.attributeTableHighRegister.shift(0))},fetch:function(){if(!(this.scanLine>=240&&this.scanLine<=260||0===this.cycle||this.cycle>=257&&this.cycle<=320||this.cycle>=337)){switch((this.cycle-1)%8){case 0:this.fetchNameTable();break;case 2:this.fetchAttributeTable();break;case 4:this.fetchPatternTableLow();break;case 6:this.fetchPatternTableHigh()}this.cycle%8==1&&(this.nameTableRegister.store(this.nameTableLatch),this.attributeTableLowRegister.storeLowerByte(this.attributeTableLowLatch),this.attributeTableHighRegister.storeLowerByte(this.attributeTableHighLatch),this.patternTableLowRegister.storeLowerByte(this.patternTableLowLatch),this.patternTableHighRegister.storeLowerByte(this.patternTableHighLatch))}},fetchNameTable:function(){this.nameTableLatch=this.load(8192|4095&this.currentVRamAddress)},fetchAttributeTable:function(){var t=this.currentVRamAddress,e=9152|3072&t|t>>4&56|t>>2&7,i=this.load(e),s=31&t,r=t>>5&31,n=r%4>=2?1:0,o=s%4>=2?1:0,c=n<<1|o,a=i>>(c<<1)&3,h=a>>1,S=1&a;this.attributeTableHighLatch=1===h?255:0,this.attributeTableLowLatch=1===S?255:0},fetchPatternTableLow:function(){var t=this.currentVRamAddress>>12&7,e=4096*this.ppuctrl.getBackgroundPatternTableNum()+16*this.nameTableRegister.load()+t;this.patternTableLowLatch=this.load(e)},fetchPatternTableHigh:function(){var t=this.currentVRamAddress>>12&7,e=4096*this.ppuctrl.getBackgroundPatternTableNum()+16*this.nameTableRegister.load()+t;this.patternTableHighLatch=this.load(e+8)},updateFlags:function(){1===this.cycle&&(241===this.scanLine?(this.ppustatus.setVBlank(),this.display.updateScreen()):261===this.scanLine&&(this.ppustatus.clearVBlank(),this.ppustatus.clearZeroHit(),this.ppustatus.clearOverflow())),10===this.cycle&&241===this.scanLine&&!0===this.ppuctrl.enabledNmi()&&this.cpu.interrupt(this.cpu.INTERRUPTS.NMI),!0===this.rom.mapper.isMMC3Mapper&&340===this.cycle&&this.scanLine<=240&&!0===this.ppumask.isBackgroundVisible()&&!0===this.ppumask.isSpritesVisible()&&this.rom.mapper.driveIrqCounter(this.cpu)},countUpScrollCounters:function(){if((!1!==this.ppumask.isBackgroundVisible()||!1!==this.ppumask.isSpritesVisible())&&!(this.scanLine>=240&&this.scanLine<=260||(261===this.scanLine&&this.cycle>=280&&this.cycle<=304&&(this.currentVRamAddress&=-31713,this.currentVRamAddress|=31712&this.temporalVRamAddress),0===this.cycle||this.cycle>=258&&this.cycle<=320))){if(this.cycle%8==0){var t=this.currentVRamAddress;31==(31&t)?(t&=-32,t^=1024):t++,this.currentVRamAddress=t}if(256===this.cycle){var t=this.currentVRamAddress;if(28672!=(28672&t))t+=4096;else{t&=-28673;var e=(992&t)>>5;29===e?(e=0,t^=2048):31===e?e=0:e++,t=-993&t|e<<5}this.currentVRamAddress=t}257===this.cycle&&(this.currentVRamAddress&=-1056,this.currentVRamAddress|=1055&this.temporalVRamAddress)}},countUpCycle:function(){++this.cycle>340&&(this.cycle=0,++this.scanLine>261&&(this.scanLine=0,this.frame++))},incrementVRamAddress:function(){this.currentVRamAddress+=this.ppuctrl.isIncrementAddressSet()?32:1,this.currentVRamAddress&=32767,this.ppuaddr.store(255&this.currentVRamAddress)},evaluateSprites:function(){if(!(this.scanLine>=240))if(0===this.cycle){this.processSpritePixels();for(var t=0,e=this.oamRam2.getCapacity();t<e;t++)this.oamRam2.store(t,255)}else if(65===this.cycle)for(var i=this.ppuctrl.isSpriteSize16()?16:8,s=0,t=0,e=this.spritesManager.getNum();t<e;t++){var r=this.spritesManager.get(t);if(!0===r.on(this.scanLine,i)){if(!(s<8)){this.ppustatus.setOverflow();break}this.spritesManager2.copy(s++,r)}}},processSpritePixels:function(){for(var t=this.scanLine-1,e=0,i=this.spritePixels.length;e<i;e++)this.spritePixels[e]=-1,this.spriteIds[e]=-1,this.spritePriorities[e]=-1;for(var s=!0===this.ppuctrl.isSpriteSize16()?16:8,e=0,i=this.spritesManager2.getNum();e<i;e++){var r=this.spritesManager2.get(e);if(r.isEmpty())break;for(var n=r.getXPosition(),o=r.getYPosition(),c=t-o,a=r.doFlipVertically()?s-c-1:c,h=r.doFlipHorizontally(),S=8===s?r.getTileIndex():r.getTileIndexForSize16(),u=r.getPalletNum(),I=0;I<8;I++){var d=h?7-I:I,l=n+I;if(l>=256)break;var N=this.getPatternTableElement(S,d,a,s);if(0!==N){var T=u<<2|N;-1===this.spritePixels[l]&&(this.spritePixels[l]=this.PALETTES[this.load(16144+T)],this.spriteIds[l]=r.getId(),this.spritePriorities[l]=r.getPriority())}}}},getPatternTableElement:function(t,e,i,s){var r,n,o=e%8;if(8===s){var c=i%8,a=1===this.ppuctrl.getSpritesPatternTableNum()?4096:0;r=this.load(a+16*t+c),n=this.load(a+16*t+8+c)}else{var c=i%8;c+=16*(i>>3),r=this.load(t+c),n=this.load(t+c+8)}return r>>7-o&1|(n>>7-o&1)<<1},dump:function(){var t="";return t+="PPU Ctrl: "+this.ppuctrl.dump()+"\n",t+="PPU Mask: "+this.ppumask.dump()+"\n",t+="PPU Status: "+this.ppustatus.dump()+"\n",t+="OAM Address: "+this.oamaddr.dump()+"\n",t+="OAM Data: "+this.oamdata.dump()+"\n",t+="PPU Scroll: "+this.ppuscroll.dump()+"\n",t+="PPU Addr: "+this.ppuaddr.dump()+"\n",t+="PPU Data: "+this.ppudata.dump()+"\n",t+="OAM DMA: "+this.oamdma.dump()+"\n",t+="\n"},dumpVRAM:function(){for(var t="",e=!1,i=0;i<65536;i++){if(i%16==0){if(e){for(var s=!1;this._checkNext16BytesIsZero(i+16);)i+=16,s=!0;s&&(t+="...\n")}t+=u.a.convertDecToHexString(i-0,4)+" ",e=!0}var r=this.load(i);t+=u.a.convertDecToHexString(r,2,!0)+" ",0!=r&&(e=!1),i%16==15&&(t+="\n")}return t},_checkNext16BytesIsZero:function(t){if(t+16>=65536)return!1;for(var e=0,i=t;i<t+16;i++)e+=this.load(i);return 0==e},dumpSPRRAM:function(){return this.oamRam.dump()}}),r.prototype=Object.assign(Object.create(h.b.prototype),{isPpuControlRegister:!0,NMI_VBLANK_BIT:7,MASTER_SLAVE_BIT:6,SPRITES_SIZE_BIT:5,BACKGROUND_PATTERN_TABLE_BIT:4,SPRITES_PATTERN_TABLE_BIT:3,INCREMENT_ADDRESS_BIT:2,NAME_TABLE_ADDRESS_BIT:0,NAME_TABLE_ADDRESS_BITS_WIDTH:2,isIncrementAddressSet:function(){return this.isBitSet(this.INCREMENT_ADDRESS_BIT)},enabledNmi:function(){return this.isBitSet(this.NMI_VBLANK_BIT)},isSpriteSize16:function(){return this.isBitSet(this.SPRITES_SIZE_BIT)},getBackgroundPatternTableNum:function(){return this.loadBit(this.BACKGROUND_PATTERN_TABLE_BIT)},getSpritesPatternTableNum:function(){return this.loadBit(this.SPRITES_PATTERN_TABLE_BIT)},getNameTableAddress:function(){return this.loadBits(this.NAME_TABLE_ADDRESS_BIT,this.NAME_TABLE_ADDRESS_BITS_WIDTH)}}),n.prototype=Object.assign(Object.create(h.b.prototype),{isPpuMaskRegister:!0,GREYSCALE_BIT:0,LEFTMOST_BACKGROUND_VISIBLE_BIT:1,LEFTMOST_SPRITES_VISIBLE_BIT:2,BACKGROUND_VISIBLE_BIT:3,SPRITES_VISIBLE_BIT:4,EMPHASIZE_RED_BIT:5,EMPHASIZE_GREEN_BIT:6,EMPHASIZE_BLUE_BIT:7,isGreyscale:function(){return this.isBitSet(this.GREYSCALE_BIT)},isLeftMostBackgroundVisible:function(){return this.isBitSet(this.LEFTMOST_BACKGROUND_VISIBLE_BIT)},isLeftMostSpritesVisible:function(){return this.isBitSet(this.LEFTMOST_SPRITES_VISIBLE_BIT)},isBackgroundVisible:function(){return this.isBitSet(this.BACKGROUND_VISIBLE_BIT)},isSpritesVisible:function(){return this.isBitSet(this.SPRITES_VISIBLE_BIT)},emphasisRed:function(){return this.isBitSet(this.EMPHASIZE_RED_BIT)},emphasisGreen:function(){return this.isBitSet(this.EMPHASIZE_GREEN_BIT)},emphasisBlue:function(){return this.isBitSet(this.EMPHASIZE_BLUE_BIT)}}),o.prototype=Object.assign(Object.create(h.b.prototype),{isPpuStatusRegister:!0,VBLANK_BIT:7,SPRITE_ZERO_HIT_BIT:6,SPRITE_OVERFLOW_BIT:5,setVBlank:function(){this.setBit(this.VBLANK_BIT)},clearVBlank:function(){this.clearBit(this.VBLANK_BIT)},setZeroHit:function(){this.setBit(this.SPRITE_ZERO_HIT_BIT)},clearZeroHit:function(){this.clearBit(this.SPRITE_ZERO_HIT_BIT)},setOverflow:function(){this.setBit(this.SPRITE_OVERFLOW_BIT)},clearOverflow:function(){this.clearBit(this.SPRITE_OVERFLOW_BIT)}}),Object.assign(c.prototype,{isSpritesManager:!0,init:function(t){for(var e=0,i=t.getCapacity()/4;e<i;e++)this.sprites.push(new a(e,e,t))},getNum:function(){return this.sprites.length},get:function(t){return this.sprites[t]},copy:function(t,e){this.sprites[t].copy(e)}}),Object.assign(a.prototype,{isSprite:!0,getId:function(){return this.id},setId:function(t){this.id=t},getByte0:function(){return this.memory.load(4*this.index+0)},getByte1:function(){return this.memory.load(4*this.index+1)},getByte2:function(){return this.memory.load(4*this.index+2)},getByte3:function(){return this.memory.load(4*this.index+3)},setByte0:function(t){this.memory.store(4*this.index+0,t)},setByte1:function(t){this.memory.store(4*this.index+1,t)},setByte2:function(t){this.memory.store(4*this.index+2,t)},setByte3:function(t){this.memory.store(4*this.index+3,t)},copy:function(t){this.setId(t.getId()),this.setByte0(t.getByte0()),this.setByte1(t.getByte1()),this.setByte2(t.getByte2()),this.setByte3(t.getByte3())},isEmpty:function(){return 255===this.getByte0()&&255===this.getByte1()&&255===this.getByte2()&&255===this.getByte3()},isVisible:function(){return this.getByte0()<239},getYPosition:function(){return this.getByte0()-1},getXPosition:function(){return this.getByte3()},getTileIndex:function(){return this.getByte1()},getTileIndexForSize16:function(){return 4096*(1&this.getByte1())+32*(this.getByte1()>>1)},getPalletNum:function(){return 3&this.getByte2()},getPriority:function(){return this.getByte2()>>5&1},doFlipHorizontally:function(){return!!(this.getByte2()>>6&1)},doFlipVertically:function(){return!!(this.getByte2()>>7&1)},on:function(t,e){return t>=this.getYPosition()&&t<this.getYPosition()+e}})},function(t,e,i){"use strict";function s(){this.cpu=null,this.audio=null,this.pulse1=new n(!0),this.pulse2=new n(!1),this.triangle=new o,this.noise=new c,this.dmc=new a(this),this.status=new h,this.frame=new S,this.cycle=0,this.step=0,this.samplePeriod=0,this.frameIrqActive=!1,this.dmcIrqActive=!1}function r(t){this.apu=t}function n(t){this.isChannel1=t,this.register0=new u.b,this.register1=new u.b,this.register2=new u.b,this.register3=new u.b,this.enabled=!1,this.timerCounter=0,this.timerPeriod=0,this.timerSequence=0,this.envelopeStartFlag=!0,this.envelopeCounter=0,this.envelopeDecayLevelCounter=0,this.lengthCounter=0,this.sweepReloadFlag=!1,this.sweepCycle=0,this.sweepCounter=0}function o(){this.register0=new u.b,this.register1=new u.b,this.register2=new u.b,this.register3=new u.b,this.enabled=!1,this.timerCounter=0,this.timerSequence=0,this.lengthCounter=0,this.linearReloadFlag=!1,this.linearCounter=0}function c(){this.register0=new u.b,this.register1=new u.b,this.register2=new u.b,this.register3=new u.b,this.enabled=!1,this.timerCounter=0,this.timerPeriod=0,this.envelopeStartFlag=!1,this.envelopeCounter=0,this.envelopeDecayLevelCounter=0,this.lengthCounter=0,this.shiftRegister=1}function a(t){this.apu=t,this.register0=new u.b,this.register1=new u.b,this.register2=new u.b,this.register3=new u.b,this.enabled=!1,this.timerPeriod=0,this.timerCounter=0,this.deltaCounter=0,this.addressCounter=0,this.remainingBytesCounter=0,this.sampleBuffer=0,this.sampleBufferIsEmpty=!0,this.shiftRegister=0,this.remainingBitsCounter=0,this.silenceFlag=!0}function h(){u.b.call(this)}function S(){u.b.call(this)}i.d(e,"a",function(){return s});var u=i(0);Object.assign(s.prototype,{isApu:!0,setCpu:function(t){this.cpu=t},setAudio:function(t){this.audio=t,this.samplePeriod=1789773/this.audio.getSampleRate()|0},bootup:function(){this.status.store(0)},reset:function(){},runCycle:function(){this.cycle++,this.cycle%this.samplePeriod==0&&this.sample(),this.cycle%2==0&&(this.pulse1.driveTimer(),this.pulse2.driveTimer(),this.noise.driveTimer(),this.dmc.driveTimer()),this.triangle.driveTimer(),this.cycle%7457==0&&(!0===this.frame.isFiveStepMode()?(this.step<4&&(this.pulse1.driveEnvelope(),this.pulse2.driveEnvelope(),this.triangle.driveLinear(),this.noise.driveEnvelope()),0!==this.step&&2!==this.step||(this.pulse1.driveLength(),this.pulse1.driveSweep(),this.pulse2.driveLength(),this.pulse2.driveSweep(),this.triangle.driveLength(),this.noise.driveLength()),this.step=(this.step+1)%5):(this.pulse1.driveEnvelope(),this.pulse2.driveEnvelope(),this.triangle.driveLinear(),this.noise.driveEnvelope(),1!==this.step&&3!==this.step||(this.pulse1.driveLength(),this.pulse1.driveSweep(),this.pulse2.driveLength(),this.pulse2.driveSweep(),this.triangle.driveLength(),this.noise.driveLength()),3===this.step&&!1===this.frame.disabledIrq()&&(this.frameIrqActive=!0),!0===this.frameIrqActive&&!1===this.frame.disabledIrq()&&this.cpu.interrupt(this.cpu.INTERRUPTS.IRQ),this.step=(this.step+1)%4),!0===this.dmcIrqActive&&this.cpu.interrupt(this.cpu.INTERRUPTS.IRQ))},loadRegister:function(t){switch(t){case 16405:var e=0;return e|=(!0===this.dmcIrqActive?1:0)<<7,e|=(!0===this.frameIrqActive&&!1===this.frame.disabledIrq()?1:0)<<6,e|=(this.dmc.remainingBytes>0?1:0)<<4,e|=(this.noise.lengthCounter>0?1:0)<<3,e|=(this.triangle.lengthCounter>0?1:0)<<2,e|=(this.pulse2.lengthCounter>0?1:0)<<1,e|=(this.pulse1.lengthCounter>0?1:0)<<0,this.frameIrqActive=!1,e}return 0},storeRegister:function(t,e){switch(t){case 16384:case 16385:case 16386:case 16387:this.pulse1.storeRegister(t,e);break;case 16388:case 16389:case 16390:case 16391:this.pulse2.storeRegister(t,e);break;case 16392:case 16393:case 16394:case 16395:this.triangle.storeRegister(t,e);break;case 16396:case 16397:case 16398:case 16399:this.noise.storeRegister(t,e);break;case 16400:case 16401:case 16402:case 16403:this.dmc.storeRegister(t,e);break;case 16405:this.status.store(e),this.dmc.setEnable(16==(16&e)),this.noise.setEnable(8==(8&e)),this.triangle.setEnable(4==(4&e)),this.pulse2.setEnable(2==(2&e)),this.pulse1.setEnable(1==(1&e)),this.dmcIrqActive=!1;break;case 16407:this.frame.store(e),!0===this.frame.disabledIrq()&&(this.frameIrqActive=!1)}},sample:function(){var t=this.pulse1.output(),e=this.pulse2.output(),i=this.triangle.output(),s=this.noise.output(),r=this.dmc.output(),n=0,o=0;0===t&&0===e||(n=95.88/(8128/(t+e)+100)),0===i&&0===s&&0===r||(o=159.79/(1/(i/8227+s/12241+r/22638)+100)),this.audio.push(n+o)},dump:function(){}}),r.LENGTH_TABLE=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],Object.assign(n.prototype,{isApuPulse:!0,LENGTH_TABLE:r.LENGTH_TABLE,DUTY_TABLE:[[0,1,0,0,0,0,0,0],[0,1,1,0,0,0,0,0],[0,1,1,1,1,0,0,0],[1,0,0,1,1,1,1,1]],storeRegister:function(t,e){switch(t){case 16384:case 16388:this.register0.store(e);break;case 16385:case 16389:this.register1.store(e),this.sweepReloadFlag=!0;break;case 16386:case 16390:this.register2.store(e),this.timerPeriod=this.getTimer();break;case 16387:case 16391:this.register3.store(e),!0===this.enabled&&(this.lengthCounter=this.LENGTH_TABLE[this.getLengthCounterIndex()]),this.timerPeriod=this.getTimer(),this.timerSequence=0,this.envelopeStartFlag=!0}},setEnable:function(t){this.enabled=t,!1===t&&(this.lengthCounter=0)},getDuty:function(){return this.register0.loadBits(6,2)},enabledEnvelopeLoop:function(){return this.register0.isBitSet(5)},disabledEnvelope:function(){return this.register0.isBitSet(4)},getEnvelopePeriod:function(){return this.register0.loadBits(0,4)},enabledSweep:function(){return this.register1.isBitSet(7)},getSweepPeriod:function(){return this.register1.loadBits(4,3)},negatedSweep:function(){return this.register1.isBitSet(3)},getSweepShiftAmount:function(){return this.register1.loadBits(0,3)},getTimerLow:function(){return this.register2.load()},getTimerHigh:function(){return this.register3.loadBits(0,3)},getTimer:function(){return this.getTimerHigh()<<8|this.getTimerLow()},getLengthCounterIndex:function(){return this.register3.loadBits(3,5)},driveTimer:function(){this.timerCounter>0?this.timerCounter--:(this.timerCounter=this.timerPeriod,8===++this.timerSequence&&(this.timerSequence=0))},driveLength:function(){!1===this.disabledEnvelope()&&this.lengthCounter>0&&this.lengthCounter--},driveEnvelope:function(){if(!0===this.envelopeStartFlag)return this.envelopeCounter=this.getEnvelopePeriod(),this.envelopeDecayLevelCounter=15,void(this.envelopeStartFlag=!1);this.envelopeCounter>0?this.envelopeCounter--:(this.envelopeCounter=this.getEnvelopePeriod(),this.envelopeDecayLevelCounter>0?this.envelopeDecayLevelCounter--:0===this.envelopeDecayLevelCounter&&!0===this.enabledEnvelopeLoop()&&(this.envelopeDecayLevelCounter=15))},driveSweep:function(){if(0===this.sweepCounter&&!0===this.enabledSweep()&&0!==this.getSweepShiftAmount()&&this.timerPeriod>=8&&this.timerPeriod<=2047){var t=this.timerPeriod>>this.getSweepShiftAmount();!0===this.negatedSweep()&&(t=-t,!0===this.isChannel1&&t--),this.timerPeriod+=t}!0===this.sweepReloadFlag||0===this.sweepCounter?(this.sweepReloadFlag=!1,this.sweepCounter=this.getSweepPeriod()):this.sweepCounter--},output:function(){return 0===this.lengthCounter||this.timerPeriod<8||this.timerPeriod>2047||0===this.DUTY_TABLE[this.getDuty()][this.timerSequence]?0:15&(!0===this.disabledEnvelope()?this.getEnvelopePeriod():this.envelopeDecayLevelCounter)}}),Object.assign(o.prototype,{isApuTriangle:!0,LENGTH_TABLE:r.LENGTH_TABLE,SEQUENCE_TABLE:[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],storeRegister:function(t,e){switch(t){case 16392:this.register0.store(e);break;case 16393:this.register1.store(e);break;case 16394:this.register2.store(e);break;case 16395:this.register3.store(e),!0===this.enabled&&(this.lengthCounter=this.LENGTH_TABLE[this.getLengthCounterIndex()]),this.timerSequence=0,this.linearReloadFlag=!0}},setEnable:function(t){this.enabled=t,!1===t&&(this.lengthCounter=0)},getLinearCounter:function(){return this.register0.loadBits(0,7)},disabledLengthCounter:function(){return this.register0.isBitSet(7)},getLengthCounterIndex:function(){return this.register3.loadBits(3,5)},getTimerLow:function(){return this.register2.load()},getTimerHigh:function(){return this.register3.loadBits(0,3)},getTimer:function(){return this.getTimerHigh()<<8|this.getTimerLow()},driveTimer:function(){this.timerCounter>0?this.timerCounter--:(this.timerCounter=this.getTimer(),this.lengthCounter>0&&this.linearCounter>0&&32===++this.timerSequence&&(this.timerSequence=0))},driveLinear:function(){!0===this.linearReloadFlag?this.linearCounter=this.getLinearCounter():this.linearCounter>0&&this.linearCounter--,!1===this.disabledLengthCounter()&&(this.linearReloadFlag=!1)},driveLength:function(){!1===this.disabledLengthCounter()&&this.lengthCounter>0&&this.lengthCounter--},output:function(){return!1===this.enabled||0===this.lengthCounter||0===this.linearCounter||this.getTimer()<2?0:15&this.SEQUENCE_TABLE[this.timerSequence]}}),Object.assign(c.prototype,{isApuNoise:!0,LENGTH_TABLE:r.LENGTH_TABLE,TIMER_TABLE:[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068],storeRegister:function(t,e){switch(t){case 16396:this.register0.store(e);break;case 16397:this.register1.store(e);break;case 16398:this.register2.store(e),this.timerPeriod=this.TIMER_TABLE[this.getTimerIndex()];break;case 16399:this.register3.store(e),!0===this.enabled&&(this.lengthCounter=this.LENGTH_TABLE[this.getLengthCounterIndex()]),this.envelopeStartFlag=!0}},setEnable:function(t){this.enabled=t,!1===t&&(this.lengthCounter=0)},disabledLengthCounter:function(){return this.register0.isBitSet(5)},disabledEnvelope:function(){return this.register0.isBitSet(4)},getEnvelopePeriod:function(){return this.register0.loadBits(0,4)},isRandom:function(){return this.register2.isBitSet(7)},getTimerIndex:function(){return this.register2.loadBits(0,4)},getLengthCounterIndex:function(){return this.register3.loadBits(3,5)},driveTimer:function(){if(this.timerCounter>0)this.timerCounter--;else{this.timerCounter=this.timerPeriod;var t=1&this.shiftRegister^this.shiftRegister>>(!0===this.isRandom()?6:1)&1;this.shiftRegister=t<<14|this.shiftRegister>>1}},driveEnvelope:function(){if(!0===this.envelopeStartFlag)return this.envelopeCounter=this.getEnvelopePeriod(),this.envelopeDecayLevelCounter=15,void(this.envelopeStartFlag=!1);this.envelopeCounter>0?this.envelopeCounter--:(this.envelopeCounter=this.getEnvelopePeriod(),this.envelopeDecayLevelCounter>0?this.envelopeDecayLevelCounter--:0===this.envelopeDecayLevelCounter&&!0===this.disabledLengthCounter()&&(this.envelopeDecayLevelCounter=15))},driveLength:function(){!1===this.disabledLengthCounter()&&this.lengthCounter>0&&this.lengthCounter--},output:function(){return 0===this.lengthCounter||1==(1&this.shiftRegister)?0:15&(!0===this.disabledEnvelope()?this.getEnvelopePeriod():this.envelopeDecayLevelCounter)}}),Object.assign(a.prototype,{isApuDmc:!0,TIMER_TABLE:[428,380,340,320,286,254,226,214,190,160,142,128,106,84,72,54],storeRegister:function(t,e){switch(t){case 16400:this.register0.store(e),this.timerPeriod=this.TIMER_TABLE[this.getTimerIndex()]>>1;break;case 16401:this.register1.store(e),this.start();break;case 16402:this.register2.store(e),this.start();break;case 16403:this.register3.store(e),this.start()}},setEnable:function(t){this.enabled=t,!0===t?0===this.remainingBytesCounter&&this.start():this.remainingBytesCounter=0},start:function(){this.deltaCounter=this.getDeltaCounter(),this.addressCounter=64*this.getSampleAddress()+49152,this.remainingBytesCounter=16*this.getSampleLength()+1},enabledIrq:function(){return this.register0.isBitSet(7)},isLoop:function(){return this.register0.isBitSet(6)},getTimerIndex:function(){return this.register0.loadBits(0,4)},getDeltaCounter:function(){return this.register1.loadBits(0,7)},getSampleAddress:function(){return this.register2.load()},getSampleLength:function(){return this.register3.load()},driveTimer:function(){this.timerCounter>0?this.timerCounter--:(this.timerCounter=this.timerPeriod,this.remainingBytesCounter>0&&!0===this.sampleBufferIsEmpty&&(this.sampleBuffer=this.apu.cpu.load(this.sampleAddress++),this.sampleBufferIsEmpty=!1,this.sampleAddress>65535&&(this.sampleAddress=32768),this.remainingBytesCounter--,0===this.remainingBytesCounter&&(!0===this.isLoop()?this.start():!0===this.enabledIrq()&&(this.apu.dmcIrqActive=!0)),this.apu.cpu.stallCycle+=4),0===this.remainingBitsCounter&&(this.remainingBitsCounter=8,!0===this.sampleBufferIsEmpty?this.silenceFlag=!0:(this.silenceFlag=!1,this.sampleBufferIsEmpty=!0,this.shiftRegister=this.sampleBuffer,this.sampleBuffer=0)),!1===this.silenceFlag&&(0==(1&this.shiftRegister)?this.deltaCounter>1&&(this.deltaCounter-=2):this.deltaCounter<126&&(this.deltaCounter+=2)),this.shiftRegister=this.shiftRegister>>1,this.remainingBitsCounter--)},output:function(){return!0===this.silenceFlag?0:127&this.deltaCounter}}),h.prototype=Object.assign(Object.create(u.b.prototype),{isApuStatusRegister:!0,ENABLE_DMC_BIT:4,ENABLE_NOISE_BIT:3,ENABLE_TRIANGLE_BIT:2,ENABLE_PULSE2_BIT:1,ENABLE_PULSE1_BIT:0}),S.prototype=Object.assign(Object.create(u.b.prototype),{isApuFrameRegister:!0,MODE_BIT:7,IRQ_BIT:6,isFiveStepMode:function(){return this.isBitSet(this.MODE_BIT)},disabledIrq:function(){return this.isBitSet(this.IRQ_BIT)}})},function(t,e,i){"use strict";function s(t){if(n.a.call(this,t),this.header=new r(this),!1===this.isNes())throw new Error("This rom doesn't seem iNES format.");this.mapper=(new o.a).create(this.header.getMapperNum(),this)}function r(t){this.rom=t}i.d(e,"a",function(){return s});var n=i(2),o=i(10),c=i(1);s.MIRRORINGS={SINGLE_SCREEN:0,HORIZONTAL:1,VERTICAL:2,FOUR_SCREEN:3},s.prototype=Object.assign(Object.create(n.a.prototype),{isRom:!0,MIRRORINGS:s.MIRRORINGS,load:function(t){var e=this.getHeaderSize();return t<8192?(e+=16384*this.header.getPRGROMBanksNum(),e+=this.mapper.mapForChrRom(t)):e+=this.mapper.map(t),this.data[e]},store:function(t,e){this.mapper.store(t,e)},isNes:function(){return this.header.isNes()},getHeaderSize:function(){return this.header.getSize()},hasChrRom:function(){return this.header.hasChrRom()},getMirroringType:function(){return this.mapper.getMirroringType()},dumpHeader:function(){return this.header.dump()},_getStartDumpAddress:function(){return this.getHeaderSize()},_getEndDumpAddress:function(){return this.getCapacity()}}),Object.assign(r.prototype,{isRomHeader:!0,size:16,VALID_SIGNATURE:"NES",VALID_MAGIC_NUMBER:26,SIGNATURE_ADDRESS:0,SIGNATURE_SIZE:3,MAGIC_NUMBER_ADDRESS:3,MAGIC_NUMBER_SIZE:1,PRG_ROM_BANKS_NUM_ADDRESS:4,PRG_ROM_BANKS_NUM_SIZE:1,CHR_ROM_BANKS_NUM_ADDRESS:5,CHR_ROM_BANKS_NUM_SIZE:1,CONTROL_BYTE1_ADDRESS:6,CONTROL_BYTE1_SIZE:1,CONTROL_BYTE2_ADDRESS:7,CONTROL_BYTE2_SIZE:1,RAM_BANKS_NUM_ADDRESS:8,RAM_BANKS_NUM_SIZE:1,UNUSED_ADDRESS:9,UNUSED_SIZE:7,MIRRORING_TYPE_BIT:0,MIRRORING_TYPE_BITS_WIDTH:1,MIRRORING_TYPE_HORIZONTAL:0,MIRRORING_TYPE_VERTICAL:1,BATTERY_BACKED_RAM_BIT:1,BATTERY_BACKED_RAM_BITS_WIDTH:1,TRAINER_512BYTES_BIT:2,TRAINER_512BYTES_BITS_WIDTH:1,FOUR_SCREEN_MIRRORING_BIT:3,FOUR_SCREEN_MIRRORING_BITS_WIDTH:1,MAPPER_LOWER_BIT:4,MAPPER_LOWER_BITS_WIDTH:4,MAPPER_HIGHER_BIT:4,MAPPER_HIGHER_BITS_WIDTH:4,getSize:function(){return this.size},isNes:function(){return this.getSignature()===this.VALID_SIGNATURE&&this.getMagicNumber()===this.VALID_MAGIC_NUMBER},load:function(t){return this.rom.loadWithoutMapping(t)},getSignature:function(){for(var t="",e=0;e<this.SIGNATURE_SIZE;e++)t+=String.fromCharCode(this.load(this.SIGNATURE_ADDRESS+e));return t},getMagicNumber:function(){return this.load(this.MAGIC_NUMBER_ADDRESS)},getPRGROMBanksNum:function(){return this.load(this.PRG_ROM_BANKS_NUM_ADDRESS)},getCHRROMBanksNum:function(){return this.load(this.CHR_ROM_BANKS_NUM_ADDRESS)},hasChrRom:function(){return this.getCHRROMBanksNum()>0},getControlByte1:function(){return this.load(this.CONTROL_BYTE1_ADDRESS)},getControlByte2:function(){return this.load(this.CONTROL_BYTE2_ADDRESS)},getRAMBanksNum:function(){return this.load(this.RAM_BANKS_NUM_ADDRESS)},getUnusedField:function(){for(var t=0,e=0;e<this.UNUSED_SIZE;e++)t=t<<8|this.load(this.UNUSED_ADDRESS+e);return t},extractBits:function(t,e,i){return t>>e&(1<<i)-1},getMirroringType:function(){return this.extractBits(this.getControlByte1(),this.MIRRORING_TYPE_BIT,this.MIRRORING_TYPE_BITS_WIDTH)},getMirroringTypeAsStrings:function(){return this.getMirroringType()===this.MIRRORING_TYPE_HORIZONTAL?"horizontal":"vertical"},isHorizontalMirroring:function(){return this.getMirroringType()===this.MIRRORING_TYPE_HORIZONTAL},getBatteryBackedRAM:function(){return this.extractBits(this.getControlByte1(),this.BATTERY_BACKED_RAM_BIT,this.BATTERY_BACKED_RAM_BITS_WIDTH)},getTrainer512Bytes:function(){return this.extractBits(this.getControlByte1(),this.TRAINER_512BYTES_BIT,this.TRAINER_512BYTES_BITS_WIDTH)},getFourScreenMirroring:function(){return this.extractBits(this.getControlByte1(),this.FOUR_SCREEN_MIRRORING_BIT,this.FOUR_SCREEN_MIRRORING_BITS_WIDTH)},getMapperNum:function(){var t=this.extractBits(this.getControlByte1(),this.MAPPER_LOWER_BIT,this.MAPPER_LOWER_BITS_WIDTH);return this.extractBits(this.getControlByte2(),this.MAPPER_HIGHER_BIT,this.MAPPER_HIGHER_BITS_WIDTH)<<this.MAPPER_LOWER_BITS_WIDTH|t},dump:function(){var t="";t+="0x ";for(var e=0;e<this.getSize();e++)t+=c.a.convertDecToHexString(this.load(e),2,!0)+" ";return t+="\n\n",t+="Signature: "+this.getSignature()+"\n",t+="Magic Number: "+c.a.convertDecToHexString(this.getMagicNumber(),2)+"\n",t+="PRG-ROM banks num: "+c.a.convertDecToHexString(this.getPRGROMBanksNum(),2)+"\n",t+="CHR-ROM banks num: "+c.a.convertDecToHexString(this.getCHRROMBanksNum(),2)+"\n",t+="Control1: "+c.a.convertDecToHexString(this.getControlByte1(),2)+"\n",t+="Control2: "+c.a.convertDecToHexString(this.getControlByte2(),2)+"\n",t+="RAM banks num: "+c.a.convertDecToHexString(this.getRAMBanksNum(),2)+"\n",t+="Unused field: "+c.a.convertDecToHexString(this.getUnusedField(),14)+"\n",t+="\n",t+="In control bytes\n",t+="Mirroring type: "+c.a.convertDecToHexString(this.getMirroringType())+"("+this.getMirroringTypeAsStrings()+")\n",t+="Battery-backed RAM: "+c.a.convertDecToHexString(this.getBatteryBackedRAM())+"\n",t+="512-byte trainer: "+c.a.convertDecToHexString(this.getTrainer512Bytes())+"\n",t+="Four screen mirroring: "+c.a.convertDecToHexString(this.getFourScreenMirroring())+"\n",t+="Mapper number: "+c.a.convertDecToHexString(this.getMapperNum(),2)+"("+(new o.a).getName(this.getMapperNum())+")"}})},function(t,e,i){"use strict";function s(){}function r(t){this.rom=t,this.prgBankNum=t.header.getPRGROMBanksNum(),this.chrBankNum=t.header.getCHRROMBanksNum()}function n(t){r.call(this,t)}function o(t){r.call(this,t),this.controlRegister=new u.b,this.chrBank0Register=new u.b,this.chrBank1Register=new u.b,this.prgBankRegister=new u.b,this.latch=new u.b,this.registerWriteCount=0,this.controlRegister.store(12)}function c(t){r.call(this,t),this.reg=new u.b}function a(t){r.call(this,t),this.reg=new u.b}function h(t){r.call(this,t),this.register0=new u.b,this.register1=new u.b,this.register2=new u.b,this.register3=new u.b,this.register4=new u.b,this.register5=new u.b,this.register6=new u.b,this.register7=new u.b,this.programRegister0=new u.b,this.programRegister1=new u.b,this.characterRegister0=new u.b,this.characterRegister1=new u.b,this.characterRegister2=new u.b,this.characterRegister3=new u.b,this.characterRegister4=new u.b,this.characterRegister5=new u.b,this.irqCounter=0,this.irqCounterReload=!1,this.irqEnabled=!0}function S(t){r.call(this,t),this.addrReg=new u.b,this.chrReg0=new u.b,this.chrReg1=new u.b,this.chrReg2=new u.b,this.chrReg3=new u.b,this.prgReg0=new u.b,this.prgReg1=new u.b}i.d(e,"a",function(){return s});var u=i(0);Object.assign(s.prototype,{isMapperFactory:!0,MAPPERS:{0:{name:"NROM",class:n},1:{name:"MMC1",class:o},2:{name:"UNROM",class:c},3:{name:"CNROM",class:a},4:{name:"MMC3",class:h},76:{name:"Mapper76",class:S}},create:function(t,e){return new(this.getMapperParam(t).class)(e)},getName:function(t){return this.getMapperParam(t).name},getMapperParam:function(t){if(void 0===this.MAPPERS[t])throw new Error("unsupport No."+t+" Mapper");return this.MAPPERS[t]}}),Object.assign(r.prototype,{isMapper:!0,map:function(t){return t-32768},mapForChrRom:function(t){return t},store:function(t,e){},getMirroringType:function(){return!0===this.rom.header.isHorizontalMirroring()?this.rom.MIRRORINGS.HORIZONTAL:this.rom.MIRRORINGS.VERTICAL}}),n.prototype=Object.assign(Object.create(r.prototype),{isNROMMapper:!0,map:function(t){return 1===this.prgBankNum&&t>=49152&&(t-=16384),t-32768}}),o.prototype=Object.assign(Object.create(r.prototype),{isMMC1Mapper:!0,map:function(t){var e=0,i=16383&t,s=15&this.prgBankRegister.load();switch(this.controlRegister.loadBits(2,2)){case 0:case 1:i|=16384&t,e=14&s;break;case 2:e=t<49152?0:s;break;case 3:e=t>=49152?this.prgBankNum-1:s}return 16384*e+i},mapForChrRom:function(t){var e,i=4095&t;return 0===this.controlRegister.loadBit(4)?(e=30&this.chrBank0Register.load(),i|=4096&t):e=31&(t<4096?this.chrBank0Register.load():this.chrBank1Register.load()),4096*e+i},store:function(t,e){if(128&e)this.registerWriteCount=0,this.latch.clear(),0==(24576&t)&&this.controlRegister.storeBits(2,2,3);else if(this.latch.store((1&e)<<4|this.latch.load()>>1),++this.registerWriteCount>=5){var i=this.latch.load();switch(24576&t){case 0:this.controlRegister.store(i);break;case 8192:this.chrBank0Register.store(i);break;case 16384:this.chrBank1Register.store(i);break;case 24576:this.prgBankRegister.store(i)}this.registerWriteCount=0,this.latch.clear()}},getMirroringType:function(){switch(this.controlRegister.loadBits(0,2)){case 0:case 1:return this.rom.MIRRORINGS.SINGLE_SCREEN;case 2:return this.rom.MIRRORINGS.VERTICAL;case 3:return this.rom.MIRRORINGS.HORIZONTAL}}}),c.prototype=Object.assign(Object.create(r.prototype),{isUNROMMapper:!0,map:function(t){return 16384*(t<49152?this.reg.load():this.prgBankNum-1)+(16383&t)},store:function(t,e){this.reg.store(15&e)}}),a.prototype=Object.assign(Object.create(r.prototype),{isCNROMMapper:!0,mapForChrRom:function(t){return 8192*this.reg.load()+(8191&t)},store:function(t,e){this.reg.store(15&e)}}),h.prototype=Object.assign(Object.create(r.prototype),{isMMC3Mapper:!0,map:function(t){t&=65535;var e=8191&t;return 8192*(t>=32768&&t<40960?!0===this.register0.isBitSet(6)?2*this.prgBankNum-2:this.programRegister0.load():t>=40960&&t<49152?this.programRegister1.load():t>=49152&&t<57344?!0===this.register0.isBitSet(6)?this.programRegister0.load():2*this.prgBankNum-2:2*this.prgBankNum-1)+e},mapForChrRom:function(t){t&=8191;var e=1023&t;return 1024*(!0===this.register0.isBitSet(7)?t>=0&&t<1024?this.characterRegister2.load():t>=1024&&t<2048?this.characterRegister3.load():t>=2048&&t<3072?this.characterRegister4.load():t>=3072&&t<4096?this.characterRegister5.load():t>=4096&&t<5120?254&this.characterRegister0.load():t>=5120&&t<6144?1|this.characterRegister0.load():t>=6144&&t<7168?254&this.characterRegister1.load():1|this.characterRegister1.load():t>=0&&t<1024?254&this.characterRegister0.load():t>=1024&&t<2048?1|this.characterRegister0.load():t>=2048&&t<3072?254&this.characterRegister1.load():t>=3072&&t<4096?1|this.characterRegister1.load():t>=4096&&t<5120?this.characterRegister2.load():t>=5120&&t<6144?this.characterRegister3.load():t>=6144&&t<7168?this.characterRegister4.load():this.characterRegister5.load())+e},store:function(t,e){if((t&=65535)>=32768&&t<40960)if(0==(1&t))this.register0.store(e);else switch(this.register1.store(e),this.register0.loadBits(0,3)){case 0:this.characterRegister0.store(254&e);break;case 1:this.characterRegister1.store(254&e);break;case 2:this.characterRegister2.store(e);break;case 3:this.characterRegister3.store(e);break;case 4:this.characterRegister4.store(e);break;case 5:this.characterRegister5.store(e);break;case 6:this.programRegister0.store(63&e);break;case 7:this.programRegister1.store(63&e)}else t>=40960&&t<49152?0==(1&t)?this.register2.store(e):this.register3.store(e):t>=49152&&t<57344?(0==(1&t)?this.register4.store(e):this.register5.store(e),this.irqCounterReload=!0):0==(1&t)?(this.register6.store(e),this.irqEnabled=!1):(this.register7.store(e),this.irqEnabled=!0)},getMirroringType:function(){return!0===this.register2.isBitSet(0)?this.rom.MIRRORINGS.HORIZONTAL:this.rom.MIRRORINGS.VERTICAL},driveIrqCounter:function(t){!0===this.irqCounterReload?(this.irqCounter=this.register4.load(),this.irqCounterReload=!1):!0===this.irqEnabled&&this.irqCounter>0&&0===--this.irqCounter&&(t.interrupt(t.INTERRUPTS.IRQ),this.irqCounterReload=!0)}}),S.prototype=Object.assign(Object.create(r.prototype),{isMapper76:!0,map:function(t){var e,i=8191&t;switch(57344&t){case 32768:e=this.prgReg0.load();break;case 40960:e=this.prgReg1.load();break;case 49152:e=2*this.prgBankNum-2;break;case 57344:e=2*this.prgBankNum-1}return 8192*e+i},mapForChrRom:function(t){var e,i=2047&t;switch(6144&t){case 0:e=this.chrReg0.load();break;case 2048:e=this.chrReg1.load();break;case 4096:e=this.chrReg2.load();break;case 6144:e=this.chrReg3.load()}return 2048*e+i},store:function(t,e){switch(57345&t){case 32768:this.addrReg.store(7&e);break;case 32769:var i;switch(this.addrReg.load()){case 0:case 1:return;case 2:i=this.chrReg0;break;case 3:i=this.chrReg1;break;case 4:i=this.chrReg2;break;case 5:i=this.chrReg3;break;case 6:i=this.prgReg0;break;case 7:i=this.prgReg1}i.store(63&e)}}})},function(t,e,i){"use strict";function s(){var t=this,e=AudioContext||webkitAudioContext;if(void 0===e)throw new Error("This browser seems not to support AudioContext.");this.bufferLength=4096,this.buffer=new Float32Array(this.bufferLength),this.bufferIndex=0,this.context=new e,this.scriptProcessor=this.context.createScriptProcessor(this.bufferLength,0,1),this.scriptProcessor.onaudioprocess=function(e){t.onAudioProcess(e)},this.scriptProcessor.connect(this.context.destination),this.sampleRate=this.context.sampleRate}i.d(e,"a",function(){return s}),Object.assign(s.prototype,{isAudio:!0,getSampleRate:function(){return this.sampleRate},onAudioProcess:function(t){for(var e=t.outputBuffer.getChannelData(0),i=0,s=this.bufferLength;i<s;i++)e[i]=this.buffer[i];for(var i=this.bufferIndex,s=this.bufferLength;i<s;i++)e[i]=0===this.bufferIndex?0:this.buffer[this.bufferIndex-1];this.bufferIndex=0},push:function(t){this.bufferIndex>=this.bufferLength||(this.buffer[this.bufferIndex++]=t)}})},function(t,e,i){"use strict";function s(t){this.ctx=t.getContext("2d"),this.width=t.width=256,this.height=t.height=240,this.data=this.ctx.createImageData(this.width,this.height),this.uint32=new Uint32Array(this.data.data.buffer)}i.d(e,"a",function(){return s}),Object.assign(s.prototype,{isDisplay:!0,renderPixel:function(t,e,i){var s=e*this.width+t;this.uint32[s]=i},updateScreen:function(){this.ctx.putImageData(this.data,0,0)}})}]);